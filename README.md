# sql_6

Задание 1
Опишите основные преимущества использования масштабирования методами:

активный master-сервер и пассивный репликационный slave-сервер;
master-сервер и несколько slave-серверов;
активный сервер со специальным механизмом репликации — distributed replicated block device (DRBD);
SAN-кластер.
Дайте ответ в свободной форме.

Ответ:

Масштабирование серверов является ключевым аспектом для обеспечения высокой доступности и повышения производительности приложений. Рассмотрим основные преимущества различных методов масштабирования.

1. Активный master-сервер и пассивный репликационный slave-сервер:
   - Высокая доступность: Пассивный slave-сервер может быстро взять на себя функции master-сервера в случае его отказа, что минимизирует время простоя.
   - Снижение нагрузки: Поскольку slave-сервер может выполнять некоторые задачи, такие как обработка запросов на чтение, основная нагрузка на master-сервер уменьшается.
   - Резервное копирование: Пассивный сервер служит резервной копией данных, что обеспечивает защиту от потери информации.

2. Master-сервер и несколько slave-серверов:
   - Балансировка нагрузки: Распределение запросов между несколькими slave-серверами позволяет улучшить производительность и уменьшить время отклика.
   - Масштабируемость: Легко добавлять новые slave-серверы по мере роста нагрузки, что позволяет гибко реагировать на изменения в требованиях.
   - Повышение отказоустойчивости: Если один из slave-серверов выходит из строя, остальные продолжают обеспечивать доступ к данным.

3. Активный сервер со специальным механизмом репликации — distributed replicated block device (DRBD):
   - Синхронная репликация: DRBD обеспечивает синхронную репликацию данных между серверами, что минимизирует риск потери данных.
   - Географическая распределенность: Возможность развертывания серверов в разных географических регионах для повышения отказоустойчивости и доступности.
   - Простота управления: DRBD позволяет управлять кластером с точки зрения одного логического устройства, что упрощает администрирование.

4. SAN-кластер:
   - Высокая производительность: Использование сетевого хранилища (SAN) позволяет обеспечить высокую скорость доступа к данным, что критично для производительных приложений.
   - Централизованное управление: SAN позволяет централизованно управлять хранилищем данных, улучшая управление ресурсами и обеспечивая более простую резервную копию и восстановление.
   - Гибкость: Легко масштабировать хранилище, добавляя новые диски или расширяя существующие массивы без значительных изменений в архитектуре.

Задание 2
Разработайте план для выполнения горизонтального и вертикального шаринга базы данных. База данных состоит из трёх таблиц:

пользователи,
книги,
магазины (столбцы произвольно).
Опишите принципы построения системы и их разграничение или разбивку между базами данных.

Пришлите блоксхему, где и что будет располагаться. Опишите, в каких режимах будут работать сервера.

Ответ:

Для выполнения горизонтального и вертикального шардинга базы данных, состоящей из трех таблиц — пользователи, книги и магазины, мы можем разработать план, который будет включать следующие этапы и принципы.

### Принципы построения системы

1. Горизонтальный шардинг:
   - Разделение данных по строкам, то есть пользователи, книги и магазины будут распределены по нескольким базам данных или серверам на основе определенного ключа. Например, для пользователей можно использовать идентификатор пользователя (user_id), а для книг и магазинов — идентификатор магазина (store_id).
   - Каждый шард будет содержать подмножество данных, что позволит улучшить производительность и масштабируемость системы.

2. Вертикальный шардинг:
   - Разделение данных по столбцам, где каждая база данных будет хранить только определенные столбцы таблиц. Например, можно создать отдельные базы данных для хранения информации о пользователях (имя, адрес), книг (название, автор) и магазинов (адрес, телефон).
   - Это позволяет оптимизировать запросы, так как каждый сервер будет обслуживать только часть данных, что улучшит производительность.

### План выполнения

1. Горизонтальный шардинг:
   - Создать несколько баз данных для пользователей, книг и магазинов.
   - Например, если у нас есть 3 шардов:
     - Shard 1: Пользователи 1-1000, Книги 1-500, Магазины 1-100.
     - Shard 2: Пользователи 1001-2000, Книги 501-1000, Магазины 101-200.
     - Shard 3: Пользователи 2001-3000, Книги 1001-1500, Магазины 201-300.

2. Вертикальный шардинг:
   - Создать отдельные базы данных для хранения разных аспектов данных.
   - Например:
     - База данных пользователей: хранит столбцы user_id, имя, адрес.
     - База данных книг: хранит столбцы book_id, название, автор.
     - База данных магазинов: хранит столбцы store_id, адрес, телефон.

### Блок-схема 

### База данных пользователей

| Таблица     | Столбцы             | Шарды                     |
|-------------|---------------------|---------------------------|
| Пользователи| user_id, имя, адрес | Shard 1: Пользователи 1-1000  |
|             |                     | Shard 2: Пользователи 1001-2000 |
|             |                     | Shard 3: Пользователи 2001-3000 |

### База данных книг

| Таблица | Столбцы                | Шарды                      |
|---------|------------------------|----------------------------|
| Книги   | book_id, название, автор| Shard 1: Книги 1-500      |
|         |                        | Shard 2: Книги 501-1000   |
|         |                        | Shard 3: Книги 1001-1500  |

### База данных магазинов

| Таблица   | Столбцы              | Шарды                     |
|-----------|----------------------|---------------------------|
| Магазины  | store_id, адрес, телефон | Shard 1: Магазины 1-100  |
|           |                      | Shard 2: Магазины 101-200 |
|           |                      | Shard 3: Магазины 201-300 |

### Режимы работы серверов

- Сервера для горизонтального шардинга:
  - Каждый сервер будет обрабатывать запросы только для своего шардированного диапазона. Это позволит распределить нагрузку и обеспечить высокую доступность.

- Сервера для вертикального шардинга:
  - Каждая база данных будет обслуживать определенные типы запросов. Например, сервер для пользователей будет отвечать только на запросы, связанные с пользователями, что позволяет оптимизировать производительность и улучшить время отклика.

Этот план позволит эффективно управлять данными, обеспечивать масштабируемость и высокую доступность системы.


Задание 3*
Выполните настройку выбранных методов шардинга из задания 2.

Пришлите конфиг Docker и SQL скрипт с командами для базы данных.

Ответ:

### Docker Compose конфигурация

version: '3.8'

services:
  db_users_shard1:
    image: postgres:latest
    environment:
      POSTGRES_DB: users_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5431:5432"

  db_users_shard2:
    image: postgres:latest
    environment:
      POSTGRES_DB: users_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"

  db_users_shard3:
    image: postgres:latest
    environment:
      POSTGRES_DB: users_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5433:5432"

  db_books_shard1:
    image: postgres:latest
    environment:
      POSTGRES_DB: books_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5434:5432"

  db_books_shard2:
    image: postgres:latest
    environment:
      POSTGRES_DB: books_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5435:5432"

  db_books_shard3:
    image: postgres:latest
    environment:
      POSTGRES_DB: books_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5436:5432"

  db_stores_shard1:
    image: postgres:latest
    environment:
      POSTGRES_DB: stores_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5437:5432"

  db_stores_shard2:
    image: postgres:latest
    environment:
      POSTGRES_DB: stores_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5438:5432"

  db_stores_shard3:
    image: postgres:latest
    environment:
      POSTGRES_DB: stores_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5439:5432"

### SQL скрипт для создания таблиц

-- Для базы данных пользователей
CREATE TABLE IF NOT EXISTS users (
    user_id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    address VARCHAR(255)
);

-- Для базы данных книг
CREATE TABLE IF NOT EXISTS books (
    book_id SERIAL PRIMARY KEY,
    title VARCHAR(255),
    author VARCHAR(100)
);

-- Для базы данных магазинов
CREATE TABLE IF NOT EXISTS stores (
    store_id SERIAL PRIMARY KEY,
    address VARCHAR(255),
    phone VARCHAR(20)
);


